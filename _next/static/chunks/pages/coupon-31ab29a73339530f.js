(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6788],{13715:function(e,o,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/coupon",function(){return n(90211)}])},90211:function(e,o,n){"use strict";n.r(o),n.d(o,{default:function(){return I}});var t=n(85893),l=n(67294),i=n(53483),a=n(7472),s=n.n(a),c=n(87066),r=n(16075),u=n(11163),d=n(29664),m=n.n(d),_=n(375),g=n(97928),h=n(28552),p=n(61435),x=n(39883),w=n(83886),f=n(747),b=n(31972),j=n.n(b),v=n(64864),C=n(30078);function N(e){let{isOpen:o,isClose:n,description:i,winCoupon:a,handleClose:s,handleAddCoupon:c}=e,[r,u]=(0,l.useState)(!1),d=(0,w.Z)({components:{MuiDialog:{styleOverrides:{paper:{width:"376px",height:"auto",borderRadius:"10rem 10rem 2.5rem 2.5rem",overflow:"visible",backgroundImage:"url(/order/coupon-bg.jpg)",backgroundSize:"cover",backgroundPosition:"center"}}},MuiBackdrop:{styleOverrides:{root:{backgroundColor:"rgba(0, 0, 0, 0.1)"}}}}}),m=()=>r?"/ghost/ghost_10.png":"/ghost/ghost_12.png",_=e=>Object.values(e).length>0;return(0,l.useEffect)(()=>{u(_(a)),m()},[a]),(0,t.jsx)(f.Z,{theme:d,children:(0,t.jsxs)(v.Z,{open:o,onClose:n,children:[(0,t.jsx)("img",{src:m(),className:j().ghostImg}),(0,t.jsxs)("div",{className:j().modalBody,children:[(0,t.jsx)("h6",{className:j().title,children:i}),r&&(0,t.jsx)("div",{className:j().couponBox,children:(0,t.jsx)(C.Z,{selectable:!1,coupon_name:a.coupon_name,minimum_order:a.minimum_order,valid_until:a.valid_until})}),r?(0,t.jsx)(p.Z,{btnText:"領取",href:null,onClick:c,paddingType:"medium"}):(0,t.jsx)(p.Z,{btnText:"關閉",href:null,onClick:s,paddingType:"medium"})]})]})})}var y=n(45747);function B(e){let{availableCoupons:o,memberId:n,fetchNewCoupons:i}=e,{openSnackbar:a}=(0,g.Ds)(),[s,r]=(0,l.useState)(0),[u,d]=(0,l.useState)(!1),[w,f]=(0,l.useState)(null),[b,j]=(0,l.useState)({}),[v,C]=(0,l.useState)(!1),{fetchMemberCartCoupons:B,fetchMemberCartProductCoupons:k}=(0,h.j)(),I=[{label:"中獎",color:"#FF6B6B"},{label:"中獎",color:"#4ECDC4"},{label:"中獎",color:"#45B7D1"},{label:"再抽一次",color:"#F9C80E"},{label:"未中獎",color:"#FF8C42"}],T=async e=>{if(!e){a("領取優惠券失敗","error");return}try{(await c.Z.post(y.US,{member_id:n,coupon_id:e})).data.status&&(j({}),f(null),i(n),B(),k(),a("已成功領取優惠券！","success"))}catch(e){console.error("Error adding coupon:",e),a("領取優惠券失敗","error")}C(!1)},E=360/I.length,Z=e=>{var o=Math.random()*e.length|0;return e[o]},O=()=>{var e=Date.now()+5e3;!function o(){(0,x.Z)({particleCount:1,startVelocity:0,ticks:200,gravity:.2,origin:{x:Math.random(),y:Math.random()-.2},colors:["#ffc0cb"],shapes:["circle"]}),Date.now()<e&&requestAnimationFrame(o)}()};return(0,t.jsxs)("div",{className:m().container,children:[console.log("Current rotation:",s),console.log("Is spinning:",u),console.log("Current winner:",w),(0,t.jsxs)("div",{className:m().wheelBox,children:[(0,t.jsx)("div",{className:m().wheelBg,style:{transform:"rotate(".concat(s,"deg)")},children:I.map((e,o)=>{let n=o/I.length*360,l=90-360/I.length;return(0,t.jsx)("div",{className:m().segment,style:{transform:"rotate(".concat(n,"deg) skewY(-").concat(l,"deg)"),background:e.color},children:(0,t.jsx)("span",{className:m().wheelText,style:{transform:"skewY(".concat(l,"deg) rotate(").concat(360/I.length/2,"deg)")},children:e.label})},o)})}),(0,t.jsx)("button",{className:m().ghostImgBox,onClick:()=>{f(null);let e=Z(o);j({coupon_id:e.id,coupon_name:e.coupon_name,valid_until:e.valid_until,minimum_order:e.minimum_order}),O(),C(!0)},children:(0,t.jsx)(_.E.img,{className:m().ghostImg,src:"/ghost/ghost_11.png",animate:{rotate:[-15,15,-15]},transition:{duration:1.5,ease:"easeInOut",repeat:1/0}})}),(0,t.jsx)("div",{className:m().pointer})]}),(0,t.jsx)(p.Z,{btnText:o.length>0?u?"旋轉中...":"我要抽獎！":"無法抽獎",href:null,onClick:()=>{if(C(!1),j({}),f(null),!u){d(!0);let e=Math.floor(Math.random()*I.length),n=E/2,t=s+1800+e*E+n;console.log("New rotation:",t=Number.isInteger(t/E)?t+E/2:t),r(t),document.documentElement.style.setProperty("--rotation-deg","".concat(t,"deg")),setTimeout(()=>{d(!1);let e=t%360;console.log("Normalized rotation:",e);let l=(I.length-Math.floor((e+n)/E))%I.length;if(console.log("Winning index:",l),console.log("Winning segment:",I[l]),f(I[l]),"中獎"===I[l].label){if(o.length>0){let e=Z(o);j({coupon_id:e.id,coupon_name:e.coupon_name,valid_until:e.valid_until,minimum_order:e.minimum_order}),O()}else j({coupon_id:null,coupon_name:"No Coupons Available"})}C(!0)},5e3)}},disabled:!(o.length>0)||u,style:{marginTop:"20px"},paddingType:"medium"}),(0,t.jsx)(N,{isOpen:v,description:w?"中獎"===w.label?"恭喜您中獎！請立即領取優惠券「".concat(b.coupon_name,"」!"):"".concat(w.label,"！"):"",winCoupon:b,handleAddCoupon:()=>T(b.coupon_id),handleClose:()=>{C(!1)}})]})}function k(){let{auth:e,authIsReady:o}=(0,r.aC)(),n=(0,u.useRouter)(),[i,a]=(0,l.useState)([]),d=async e=>{try{let o=await c.Z.get("".concat(y.A5,"?member_id=").concat(e));o.data.status&&(a(o.data.rows),console.log("fetch available coupons!!!!!!!",o.data.rows))}catch(e){console.error("Error fetching available coupons:",e)}};return(0,l.useEffect)(()=>{n.isReady&&o&&e.id&&d(e.id)},[e.id,n.isReady,o]),(0,t.jsxs)("section",{className:s().sectionContainer,children:[(0,t.jsx)("h3",{className:s().title,children:"領取優惠券"}),(0,t.jsx)("div",{className:s().wheelContainer,children:(0,t.jsx)(B,{availableCoupons:i,memberId:e.id,fetchNewCoupons:d})}),(0,t.jsxs)("div",{className:s().couponContainer,children:[(0,t.jsx)("h6",{children:"快來抽獎把優惠券拿回家吧！"}),(0,t.jsx)("div",{className:s().couponGrid,children:i.length>0&&i.map((e,o)=>(0,t.jsx)(C.Z,{coupon_id:e.id,coupon_name:e.coupon_name,minimum_order:e.minimum_order,valid_until:e.valid_until,btnHidden:!0,selectable:!1},e.id))})]})]})}function I(){return(0,t.jsx)(i.Z,{title:"領取優惠券",background:"light",children:(0,t.jsx)(k,{})})}},29664:function(e){e.exports={container:"coupon-wheel_container__sKfn9",wheelBox:"coupon-wheel_wheelBox__tcjpl",wheelBg:"coupon-wheel_wheelBg__kcOYs",segment:"coupon-wheel_segment__g_zMN",ghostImgBox:"coupon-wheel_ghostImgBox__IBc6I",ghostImg:"coupon-wheel_ghostImg__oTWII",wheelText:"coupon-wheel_wheelText__7_aox",pointer:"coupon-wheel_pointer__OKUfq",resultBox:"coupon-wheel_resultBox__I5nIa"}},31972:function(e){e.exports={modalBody:"coupon-win-dialog_modalBody__fLsHl",ghostImg:"coupon-win-dialog_ghostImg__48mCN",couponBox:"coupon-win-dialog_couponBox__AmFpz",title:"coupon-win-dialog_title__Jj5WW"}},7472:function(e){e.exports={title:"get-coupon-section_title___jxL0",sectionContainer:"get-coupon-section_sectionContainer__GHHz0",wheelContainer:"get-coupon-section_wheelContainer__Q0k4o",couponContainer:"get-coupon-section_couponContainer__2uLPf",couponGrid:"get-coupon-section_couponGrid__OS8bj"}}},function(e){e.O(0,[5970,4838,9317,4396,6660,509,2961,4321,959,6497,9883,3483,2888,9774,179],function(){return e(e.s=13715)}),_N_E=e.O()}]);